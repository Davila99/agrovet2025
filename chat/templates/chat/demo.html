<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat demo - Agrovet</title>
    <link rel="stylesheet" href="/static/chat/demo.css" />
  </head>
  <body>
    <div class="demo">
      <h1>Chat demo</h1>
      <div class="controls">
        <label>Room id: <input id="room" value="1" /></label>
        <label>Token: <input id="token" placeholder="Token or Bearer ..." style="width:400px" /></label>
        <button id="test-token">Test token (HTTP)</button>
        <button id="connect">Connect</button>
        <button id="disconnect">Disconnect</button>
      </div>

      <div id="status" class="status">Not connected</div>

      <div class="chat-area">
        <div id="messages" class="messages"></div>
      </div>

      <div class="send-area">
        <input id="text" placeholder="Type a message" />
        <button id="send">Send</button>
      </div>

      <p class="notes">Notes: use a DRF token (Token xxxxx) or raw token in the Token field. The demo will try to create a ws:// or wss:// connection to the same host.</p>
    </div>

    <script>
    (function(){
      let sock = null;
      const roomEl = document.getElementById('room');
      const tokenEl = document.getElementById('token');
      const connectBtn = document.getElementById('connect');
      const disconnectBtn = document.getElementById('disconnect');
      const status = document.getElementById('status');
      const messages = document.getElementById('messages');
      const text = document.getElementById('text');
      const sendBtn = document.getElementById('send');

      function addMessage(who, txt){
        const d = document.createElement('div');
        d.className = 'msg';
        d.innerHTML = '<b>'+who+'</b>: '+(txt||'');
        messages.appendChild(d);
        messages.scrollTop = messages.scrollHeight;
      }

      function getWsUrl(room){
        const token = (tokenEl.value||'').replace(/^Token\s*/i,'').replace(/^Bearer\s*/i,'');
        const proto = location.protocol === 'https:' ? 'wss' : 'ws';
        const host = location.host;
        const q = token ? ('?token='+encodeURIComponent(token)+'&access_token='+encodeURIComponent(token)) : '';
        return proto + '://' + host + '/ws/chat/' + encodeURIComponent(room) + '/' + q;
      }

      document.getElementById('test-token').addEventListener('click', async function(){
        const tk = tokenEl.value||'';
        if (!tk) return addMessage('system','no token provided');
        const raw = tk.replace(/^Token\s*/i,'').replace(/^Bearer\s*/i,'');
        addMessage('system','testing token via HTTP /api/auth/profile/ ...');
        try{
          const res = await fetch('/api/auth/profile/', { headers: { 'Authorization': 'Token '+raw } });
          if (!res.ok) { addMessage('system','HTTP token test failed: '+res.status); const txt = await res.text(); addMessage('system', txt); return; }
          const data = await res.json(); addMessage('system','HTTP token test OK: '+(data.username||data.id||JSON.stringify(data)));
        }catch(e){ addMessage('system','HTTP test error: '+(e && e.message)); }
      });

      connectBtn.addEventListener('click', function(){
        if (sock) return addMessage('system','already connected');
        const room = roomEl.value || '1';
        const tokenRaw = tokenEl.value || '';
        const tokenShown = tokenRaw ? (tokenRaw.substr(0,8) + '...') : 'â€”';
        const url = getWsUrl(room);
        addMessage('system','connecting to '+url);
        addMessage('system','token (masked): '+tokenShown);
        try{
          sock = new WebSocket(url);
        }catch(e){ addMessage('system','WebSocket constructor failed: '+(e && e.message)); return; }

        function stateName(s){ return ['CONNECTING','OPEN','CLOSING','CLOSED'][s] || s }

        sock.onopen = function(){ status.textContent = 'Connected'; addMessage('system','connected - state: '+stateName(sock.readyState)); };
        sock.onmessage = function(ev){ try{ const d = JSON.parse(ev.data); addMessage('recv', JSON.stringify(d)); }catch(e){ addMessage('recv', ev.data); } };
        sock.onclose = function(ev){ status.textContent = 'Disconnected'; addMessage('system','disconnected - code:'+ev.code+' reason:'+ev.reason+' state:'+stateName(sock.readyState)); sock = null; };
        sock.onerror = function(e){ addMessage('system','error event (check server logs).'); };
      });

      disconnectBtn.addEventListener('click', function(){ if (sock){ try{ sock.close(); }catch(e){} } });

      sendBtn.addEventListener('click', function(){
        if (!sock || sock.readyState !== WebSocket.OPEN) return addMessage('system','socket not open');
        const txt = text.value || '';
        const payload = { message: txt };
        sock.send(JSON.stringify(payload));
        addMessage('me', JSON.stringify(payload));
        text.value = '';
      });
    })();
    </script>
  </body>
  </html>
