<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chat Test Client (simple)</title>
    <link rel="stylesheet" href="/static/chat/demo.css" />
    <style>
      :root{
        --bg:#f4f6fa; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --accent-2:#0ea5a9;
        --me-bg:linear-gradient(135deg,var(--accent),#7c3aed); --other-bg:#eef2ff;
      }
      body{font-family:Inter,ui-sans-serif,system-ui,Arial,Helvetica,sans-serif;background:var(--bg);padding:24px}
      .container{max-width:900px;margin:0 auto}
      .panel{background:var(--card);border-radius:12px;box-shadow:0 6px 24px rgba(12,15,20,0.06);overflow:hidden}
      header.app-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid #f0f3f7}
      .brand{display:flex;gap:12px;align-items:center}
      .logo{width:42px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
      .title{font-size:16px;font-weight:600}
      #user-name{font-weight:600;color:#111827}
      .cols{display:grid;grid-template-columns:320px 1fr}
      .sidebar{border-right:1px solid #f0f3f7;padding:16px}
      .box{background:transparent;padding:0;margin:0}
      .row{display:flex;gap:8px;align-items:center}
      input[type=text], input[type=password]{padding:10px;border:1px solid #e6e9ef;border-radius:8px}
      button{padding:8px 12px;border-radius:8px;border:0;background:var(--accent);color:white;cursor:pointer}
      button.secondary{background:transparent;color:var(--accent);border:1px solid #e6e9ef}

      /* Chat area */
      .chat-main{display:flex;flex-direction:column;height:540px}
      #messages{flex:1;overflow:auto;padding:20px;background:linear-gradient(180deg,#fbfdff,#f7f9fc)}
      .msg{display:flex;margin-bottom:12px;align-items:flex-end}
      .msg .bubble{max-width:72%;padding:10px 14px;border-radius:14px;line-height:1.3;font-size:14px}
      .msg.me{justify-content:flex-end}
      .msg.me .bubble{background:var(--me-bg);color:white;border-bottom-right-radius:6px;border-bottom-left-radius:14px}
      .msg.other{justify-content:flex-start}
      .msg.other .bubble{background:var(--other-bg);color:#0f172a;border-bottom-left-radius:6px;border-bottom-right-radius:14px}
      .meta{font-size:12px;color:var(--muted);margin-left:8px}
      .composer{display:flex;padding:14px;border-top:1px solid #f0f3f7;gap:8px}
      .composer input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6e9ef}

      /* small utilities */
      .small{font-size:13px;color:var(--muted)}
      .system-msg{color:var(--muted);font-size:13px;margin-bottom:8px}
    </style>
  </head>
  <body>
    <div class="container">
      <div class="panel">
        <header class="app-header">
          <div class="brand"><div class="logo">CV</div><div><div class="title">AgroVet Chat â€” Test</div><div class="small">Real-time chat playground</div></div></div>
          <div id="user-display" style="text-align:right">
            <div class="small">Logged in as</div>
            <div id="user-name">Guest</div>
            <div id="room-header" style="margin-top:8px;display:flex;align-items:center;justify-content:flex-end;gap:8px">
              <div id="room-avatar" style="width:36px;height:36px;border-radius:50%;background:#e6eefc;color:#0b1f5a;display:inline-flex;align-items:center;justify-content:center;font-weight:700">?</div>
              <div style="text-align:right"><div class="small">In room with</div><div id="room-header-name">(no one)</div></div>
            </div>
          </div>
        </header>
        <div class="cols">
          <aside class="sidebar">
            <div style="margin-bottom:12px"><strong>Login</strong></div>
            <div class="row" style="margin-bottom:8px"><input id="login-phone" type="text" placeholder="phone_number" style="flex:1" /><input id="login-pass" type="password" placeholder="password" style="flex:1; margin-left:8px" /></div>
            <div class="row" style="margin-bottom:12px"><button type="button" id="btn-login">Login</button><button type="button" id="btn-logout" class="secondary">Logout</button></div>
            <div id="login-status" class="system-msg"></div>

            <hr style="margin:12px 0;border:none;border-top:1px solid #f0f3f7" />

            <div style="margin-bottom:8px"><strong>Create Room</strong></div>
            <div class="row" style="margin-bottom:8px"><input id="room-participants" type="text" placeholder="participants ids e.g. 2,3" style="width:100%" /></div>
            <div class="row" style="margin-bottom:6px"><label><input id="room-private" type="checkbox" /> Private</label></div>
            <div class="row" style="margin-bottom:6px"><button type="button" id="btn-create-room">Create</button></div>
            <div id="room-result" class="small"></div>
            <hr style="margin:12px 0;border:none;border-top:1px solid #f0f3f7" />
            <div style="margin-bottom:8px"><strong>Connect to Room</strong></div>
            <div class="row" style="margin-bottom:8px"><input id="room-id" type="text" placeholder="room id (e.g. 11)" style="flex:1" /><button type="button" id="btn-connect" style="margin-left:8px">Connect</button><button type="button" id="btn-disconnect" class="secondary" style="margin-left:8px">Disconnect</button></div>
            <div style="margin-top:8px"><strong>Other participant:</strong> <span id="room-other-name" class="small">(none)</span></div>
          </aside>
          <main class="chat-main">
            <div id="messages"></div>
            <div class="composer">
              <input id="msg-text" type="text" placeholder="Type a message" />
              <button type="button" id="btn-send">Send</button>
            </div>
            <div style="padding:10px 16px"><span class="small">WS status: <span id="ws-status">CLOSED</span></span></div>
          </main>
        </div>
      </div>
    </div>

    <div style="color:#666;font-size:13px">This simple client uses API endpoints: <code>/api/auth/login/</code> and <code>/api/chat/rooms/</code>. WS path: <code>/ws/chat/&lt;room&gt;/?token=&lt;key&gt;</code></div>

    <script>
    (function(){
      // Clean, robust client initialization. Attaches listeners after DOM ready
      function qs(id){ return document.getElementById(id); }

      function timeNow(){ const dt = new Date(); return dt.getHours().toString().padStart(2,'0')+':'+dt.getMinutes().toString().padStart(2,'0'); }
      function safeText(node, text){ if(!node) return; node.textContent = text; }

      function initClient(){
        console.debug('[test-client] initClient');
        let token = null;
        let sock = null;

        const loginPhone = qs('login-phone');
        const loginPass = qs('login-pass');
        const btnLogin = qs('btn-login');
        const btnLogout = qs('btn-logout');
        const loginStatus = qs('login-status');
        const btnCreateRoom = qs('btn-create-room');
        const roomParticipants = qs('room-participants');
        const roomPrivate = qs('room-private');
        const roomResult = qs('room-result');
        const btnConnect = qs('btn-connect');
        const roomIdInput = qs('room-id');
        const roomOtherName = qs('room-other-name');
        const btnDisconnect = qs('btn-disconnect');
        const roomAvatar = qs('room-avatar');
        const roomHeaderName = qs('room-header-name');
        const wsStatus = qs('ws-status');
        const messages = qs('messages');
        const msgText = qs('msg-text');
        const btnSend = qs('btn-send');
        const userNameEl = qs('user-name');

        function addMessage(who, text, opts){
          try{
            if(!messages){ console.log('[test-client] no #messages element:', who, text); return; }
            const row = document.createElement('div'); row.className = who==='me' ? 'msg me' : 'msg other';
            const bubble = document.createElement('div'); bubble.className='bubble';
            const ts = (opts && opts.ts) ? opts.ts : timeNow();
            bubble.innerHTML = '<div style="font-size:12px;color:#374151;margin-bottom:6px"><b>'+(who)+'</b></div><div>'+ (text||'') +'</div><div class="meta" style="text-align:right;margin-top:6px">'+ts+'</div>';
            if(opts && opts.client_msg_id) row.setAttribute('data-client-msg-id', opts.client_msg_id);
            row.appendChild(bubble);
            messages.appendChild(row);
            messages.scrollTop = messages.scrollHeight;
            return row;
          }catch(err){ console.error('[test-client] addMessage error', err); }
        }

        function wsUrlForRoom(room){ const proto = location.protocol==='https:'?'wss':'ws'; const q = token?('?token='+encodeURIComponent(token)) : ''; return proto+'://'+location.host+'/ws/chat/'+encodeURIComponent(room)+'/'+q; }

        function setRoomHeader(name){ try{ if(roomOtherName) roomOtherName.textContent = name || '(no one)'; if(roomHeaderName) roomHeaderName.textContent = name || '(no one)'; if(roomAvatar) roomAvatar.textContent = (name||'?').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase(); }catch(e){ } }

        function openSocket(room){
          if(!token){ addMessage('system','login first'); return; }
          const url = wsUrlForRoom(room);
          addMessage('system','connecting to '+url);
          try{ sock = new WebSocket(url); }catch(e){ addMessage('system','ws ctor failed: '+e.message); return; }
          if(wsStatus) wsStatus.textContent = 'CONNECTING';
          sock.onopen = ()=>{ if(wsStatus) wsStatus.textContent='OPEN'; addMessage('system','ws open'); };
          sock.onmessage = ev=>{
            try{
              const d = JSON.parse(ev.data);
              // correlate optimistic echo
              if(d.client_msg_id){ const local = messages && messages.querySelector('[data-client-msg-id="'+d.client_msg_id+'"]'); if(local){ local.classList.remove('me'); local.classList.add('other'); const bubble = local.querySelector('.bubble'); if(bubble) bubble.innerHTML = '<div style="font-size:12px;color:#374151;margin-bottom:6px"><b>'+(d.username||'recv')+'</b></div><div>'+(d.message||'')+'</div><div class="meta" style="text-align:right;margin-top:6px">'+(d.timestamp||timeNow())+'</div>'; local.removeAttribute('data-client-msg-id'); messages.scrollTop = messages.scrollHeight; setRoomHeader(d.username||'(no one)'); return; } }
              // fallback: render server message
              addMessage(d.username||'recv', d.message||ev.data, { ts: d.timestamp || timeNow() });
              setRoomHeader(d.username||'(no one)');
            }catch(e){ addMessage('recv', ev.data); }
          };
          sock.onclose = ev=>{ if(wsStatus) wsStatus.textContent='CLOSED'; addMessage('system','ws close: code='+ev.code+' reason='+(ev.reason||'')); sock=null; };
          sock.onerror = e=>{ addMessage('system','ws error (see server logs)'); console.debug('[test-client] ws error', e); };
        }

        // Attach button handlers (safe guards and debug logs)
        if(btnLogin) btnLogin.addEventListener('click', async ()=>{
          console.debug('[test-client] login click');
          const phone = (loginPhone && loginPhone.value)||'';
          const password = (loginPass && loginPass.value)||'';
          if(!phone){ if(loginStatus) loginStatus.textContent='phone_number required'; addMessage('system','phone_number required'); return; }
          try{
            const res = await fetch('/api/auth/login/', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ phone_number: phone, password }) });
            const txt = await res.text(); if(!res.ok){ addMessage('system','login failed: '+res.status); return; }
            const data = JSON.parse(txt); token = (data.token||'').trim(); safeText(loginStatus, token? 'Logged in':'Logged in'); safeText(userNameEl, (data.user && (data.user.full_name || data.user.phone_number))||'Me'); addMessage('system','login OK');
          }catch(err){ console.error('[test-client] login error', err); addMessage('system','login error'); }
        });

        if(btnLogout) btnLogout.addEventListener('click', ()=>{ console.debug('[test-client] logout click'); token = null; safeText(loginStatus,'Logged out'); addMessage('system','logged out'); safeText(userNameEl,'Guest'); });

        if(btnCreateRoom) btnCreateRoom.addEventListener('click', async ()=>{
          console.debug('[test-client] create-room click'); if(!token) return addMessage('system','login first'); const raw = (roomParticipants && roomParticipants.value)||''; const participants = raw? raw.split(',').map(s=>parseInt(s.trim())).filter(Boolean):[]; const payload = { participants, is_private: !!(roomPrivate && roomPrivate.checked) };
          try{ const res = await fetch('/api/chat/rooms/', { method:'POST', headers:{ 'Content-Type':'application/json','Authorization':'Token '+token }, body: JSON.stringify(payload) }); const txt = await res.text(); if(!res.ok){ addMessage('system','create room failed: '+res.status); return; } const data = JSON.parse(txt); if(roomResult) roomResult.textContent = JSON.stringify(data); addMessage('system','room created: '+(data.id||'(unknown)')); }catch(err){ console.error('[test-client] create room error', err); addMessage('system','create room error'); }
        });

        if(btnConnect) btnConnect.addEventListener('click', ()=>{ console.debug('[test-client] connect click'); const room = (roomIdInput && roomIdInput.value)||'11'; if(!room) return addMessage('system','enter room id'); openSocket(room); });

        if(btnDisconnect) btnDisconnect.addEventListener('click', ()=>{ console.debug('[test-client] disconnect click'); if(sock){ try{ sock.close(); }catch(e){} } else addMessage('system','not connected'); });

        if(btnSend) btnSend.addEventListener('click', ()=>{ console.debug('[test-client] send click'); if(!msgText) return; if(!sock || sock.readyState !== WebSocket.OPEN) return addMessage('system','socket not open'); const client_msg_id = 'cmsg_'+Date.now()+'_'+Math.floor(Math.random()*10000); const payload = { content: (msgText.value||'').trim(), client_msg_id }; try{ sock.send(JSON.stringify(payload)); }catch(e){ addMessage('system','send failed'); return; } addMessage('me', payload.content, { client_msg_id, ts: timeNow() }); msgText.value=''; });

        // enter -> send when focus is on input
        if(msgText) msgText.addEventListener('keydown', e=>{ if(e.key==='Enter'){ if(btnSend) btnSend.click(); } });
      }

      if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initClient); else initClient();
    })();
    </script>
  </body>
  </html>
