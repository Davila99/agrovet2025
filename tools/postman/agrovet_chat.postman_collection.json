{
  "info": {
    "_postman_id": "agrovet-chat-collection",
    "name": "Agrovet Chat - Quick Tests",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Collection para probar login, crear sala, subir media y mensajes (REST)."
  },
  "variable": [
    { "key": "base_url", "value": "http://127.0.0.1:8000" },
    { "key": "auth_token", "value": "" },
    { "key": "specialist_pk", "value": "1" },
    { "key": "room_id", "value": "" },
    { "key": "media_id", "value": "" }
  ],
  "item": [
    {
      "name": "1 - Login (obtener token)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"username\": \"testuser\",\n  \"password\": \"password123\"\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": { "raw": "{{base_url}}/api/auth/login/", "host": ["{{base_url}}"], "path": ["api","auth","login",""] }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "var json = pm.response.json();",
              "if (json.token) { pm.environment.set('auth_token', json.token); }",
              "pm.test('Has token', function() { pm.expect(json.token).to.exist; });"
            ]
          }
        }
      ]
    },
    {
      "name": "2 - Crear sala (private)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Token {{auth_token}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"participants\": [1, 2],\n  \"is_private\": true\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": { "raw": "{{base_url}}/api/chat/rooms/", "host": ["{{base_url}}"], "path": ["api","chat","rooms",""] }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "var json = pm.response.json();",
              "if (json.id) { pm.environment.set('room_id', json.id); }",
              "pm.test('Room created', function() { pm.expect(json.id).to.exist; });"
            ]
          }
        }
      ]
    },
    {
      "name": "3 - Upload work images (SpecialistProfile)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Authorization", "value": "Token {{auth_token}}" }
        ],
        "body": {
          "mode": "formdata",
          "formdata": [
            {
              "key": "images",
              "type": "file",
              "src": ["/path/to/work1.jpg"]
            }
          ]
        },
        "url": { "raw": "{{base_url}}/api/profiles/specialists/{{specialist_pk}}/upload_work_images/", "host": ["{{base_url}}"], "path": ["api","profiles","specialists","{{specialist_pk}}","upload_work_images",""] }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "var json = pm.response.json();",
              "if (Array.isArray(json) && json.length>0) { pm.environment.set('media_id', json[0].id); }",
              "pm.test('Media created', function() { pm.expect(json.length).to.be.above(0); });"
            ]
          }
        }
      ]
    },
    {
      "name": "4 - Post message (REST)",
      "request": {
        "method": "POST",
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "Authorization", "value": "Token {{auth_token}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"room\": {{room_id}},\n  \"content\": \"Hello from Postman\",\n  \"media\": {{media_id}}\n}",
          "options": { "raw": { "language": "json" } }
        },
        "url": { "raw": "{{base_url}}/api/chat/messages/", "host": ["{{base_url}}"], "path": ["api","chat","messages",""] }
      }
    },
    {
      "name": "5 - Get last messages",
      "request": {
        "method": "GET",
        "header": [
          { "key": "Authorization", "value": "Token {{auth_token}}" }
        ],
        "url": { "raw": "{{base_url}}/api/chat/messages/last_messages/?room={{room_id}}&limit=20", "host": ["{{base_url}}"], "path": ["api","chat","messages","last_messages",""], "query": [ { "key": "room", "value": "{{room_id}}" }, { "key": "limit", "value": "20" } ] }
      }
    }
  ]
}
