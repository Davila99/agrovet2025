{
  "info": {
    "_postman_id": "populate-agrovet",
    "name": "Agrovet - Populate & Test",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Requests para crear usuarios, perfiles y probar chat + media"
  },
  "variable": [
    { "key": "base_url", "value": "http://127.0.0.1:8000" },
    { "key": "client_token", "value": "" },
    { "key": "specialist_token", "value": "" },
    { "key": "client_id", "value": "" },
    { "key": "specialist_id", "value": "" },
    { "key": "specialist_profile_pk", "value": "" },
    { "key": "media_id", "value": "" },
    { "key": "room_id", "value": "" }
  ],
  "item": [
    {
      "name": "1 - Create client user",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"phone_number\": \"+50000000001\",\n  \"password\": \"password123\",\n  \"full_name\": \"Cliente Test\"\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/auth/register/", "host": ["{{base_url}}"], "path": ["api","auth","register",""] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json(); if (json.id) pm.environment.set('client_id', json.id); pm.test('created', () => pm.expect(json.id).to.exist);" ] } } ]
    },
    {
      "name": "2 - Create specialist user",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"phone_number\": \"+50000000002\",\n  \"password\": \"password123\",\n  \"full_name\": \"Dr. Test\"\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/auth/register/", "host": ["{{base_url}}"], "path": ["api","auth","register",""] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json(); if (json.id) pm.environment.set('specialist_id', json.id); pm.test('created', () => pm.expect(json.id).to.exist);" ] } } ]
    },
    {
      "name": "3 - Login client (get token)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"phone_number\": \"+50000000001\",\n  \"password\": \"password123\"\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/auth/login/", "host": ["{{base_url}}"], "path": ["api","auth","login",""] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json(); if (json.token) pm.environment.set('client_token', json.token); pm.test('token', () => pm.expect(json.token).to.exist);" ] } } ]
    },
    {
      "name": "4 - Login specialist (get token)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" } ],
        "body": { "mode": "raw", "raw": "{\n  \"phone_number\": \"+50000000002\",\n  \"password\": \"password123\"\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/auth/login/", "host": ["{{base_url}}"], "path": ["api","auth","login",""] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json(); if (json.token) pm.environment.set('specialist_token', json.token); pm.test('token', () => pm.expect(json.token).to.exist);" ] } } ]
    },
    {
      "name": "5 - Set specialist coords (PATCH user)",
      "request": {
        "method": "PATCH",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Token {{specialist_token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"latitude\": 12.1150,\n  \"longitude\": -86.2362\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/auth/users/{{specialist_id}}/", "host": ["{{base_url}}"], "path": ["api","auth","users","{{specialist_id}}",""] }
      }
    },
    {
      "name": "6 - Create SpecialistProfile (specialist)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Token {{specialist_token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"profession\": \"Veterinario\",\n  \"specialty\": \"veterinarian\",\n  \"experience_years\": 8,\n  \"about_us\": \"Clinica Test Dr.\"\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/profiles/specialists/", "host": ["{{base_url}}"], "path": ["api","profiles","specialists",""] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json(); pm.test('created', () => pm.expect(json.user).to.exist);" ] } } ]
    },
    {
      "name": "7 - Upload work image (specialist)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Authorization", "value": "Token {{specialist_token}}" } ],
        "body": { "mode": "formdata", "formdata": [ { "key": "images", "type": "file", "src": ["/path/to/work1.jpg"] } ] },
        "url": { "raw": "{{base_url}}/api/profiles/specialists/{{specialist_profile_pk}}/upload_work_images/", "host": ["{{base_url}}"], "path": ["api","profiles","specialists","{{specialist_profile_pk}}","upload_work_images",""] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json(); if (Array.isArray(json) && json.length>0) pm.environment.set('media_id', json[0].id); pm.test('uploaded', () => pm.expect(json.length).to.be.above(0));" ] } } ]
    },
    {
      "name": "8 - Create room (client + specialist)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Token {{client_token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"participants\": [{{client_id}}, {{specialist_id}}],\n  \"is_private\": true\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/chat/rooms/", "host": ["{{base_url}}"], "path": ["api","chat","rooms",""] }
      },
      "event": [ { "listen": "test", "script": { "exec": [ "var json = pm.response.json(); if (json.id) pm.environment.set('room_id', json.id); pm.test('room', () => pm.expect(json.id).to.exist);" ] } } ]
    },
    {
      "name": "9 - Post a message (REST)",
      "request": {
        "method": "POST",
        "header": [ { "key": "Content-Type", "value": "application/json" }, { "key": "Authorization", "value": "Token {{client_token}}" } ],
        "body": { "mode": "raw", "raw": "{\n  \"room\": {{room_id}},\n  \"content\": \"Hola Dr, este es un mensaje de prueba\",\n  \"media\": {{media_id}}\n}", "options": { "raw": { "language": "json" } } },
        "url": { "raw": "{{base_url}}/api/chat/messages/", "host": ["{{base_url}}"], "path": ["api","chat","messages",""] }
      }
    },
    {
      "name": "10 - Get last messages",
      "request": {
        "method": "GET",
        "header": [ { "key": "Authorization", "value": "Token {{client_token}}" } ],
        "url": { "raw": "{{base_url}}/api/chat/messages/last_messages/?room={{room_id}}&limit=50", "host": ["{{base_url}}"], "path": ["api","chat","messages","last_messages",""], "query": [ { "key": "room", "value": "{{room_id}}" }, { "key": "limit", "value": "50" } ] }
      }
    }
  ]
}
